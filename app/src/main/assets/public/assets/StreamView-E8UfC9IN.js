import{_ as S,o as m,c as u,a as i,s,m as r,V as D,t as d,b as y,d as g,n as h,e as I,r as f}from"./index-CQEIhx4D.js";const _={name:"LoadingRing"},b={class:"loading"};function k(a,e,l,o,t,n){return m(),u("div",b,e[0]||(e[0]=[i("div",null,null,-1),i("div",null,null,-1),i("div",null,null,-1),i("div",null,null,-1),i("div",null,null,-1),i("div",null,null,-1),i("div",null,null,-1),i("div",null,null,-1),i("div",null,null,-1)]))}const T=S(_,[["render",k],["__scopeId","data-v-863ed005"]]),R={name:"StreamView",data(){return{connectionAttempts:0,maxAttempts:3,isReady:!1,playbackDelta:null,get method(){return s.app.method},get roleDescription(){return this.isSlave?"成员":"房间"},get hint(){return this.isSlave?"请耐心等待。正在全球互联网寻找您的伙伴...":"号码已复制。请您将号码发送给您的伙伴。"},get loadingDescription(){return s.app.mode==1?"正在加入伙伴":"正在等待伙伴"},get roomID(){return this.isSlave&&s.app.guestID?s.app.guestID:s.app.roomID},get isSlave(){return s.app.mode==1}}},methods:{connectToPeer(){const a=`${s.app.roomID}-data`,e=s.peers.local.data;e.disconnected&&e.reconnect(),r.i(`尝试连接到 ${a} (第 ${this.connectionAttempts+1} 次)`);const l=e.connect(a,{reliable:!0});l.on("open",()=>{l.send(`connected@${s.app.guestID}`),r.i(`和 ${s.app.roomID} 的连接已建立`),s.peers.local.video.on("call",o=>{o.answer(),o.on("stream",t=>{r.i("收到视频流");const n=document.getElementById("video-player-stream");n.srcObject=t,n.load(),n.play()})}),this.isReady=!0,s.peers.remote.data=l}),l.on("data",o=>{const t=document.getElementById("video-player-stream");if(o.toString().startsWith("origin")){s.app.method=1;const n=o.toString().split("@")[1];t.src=n,s.app.syncThread=setInterval(()=>{r.i(`发送当前视频进度: ${t.currentTime}`),l.send(`video@sync:${t.currentTime}`)},"1"*1e3)}else if(o.toString().startsWith("video")){const n=o.toString().split("@")[1];if(n==="play")t.play();else if(n==="pause")t.pause();else if(n.startsWith("seek")){const p=o.toString().split("@")[1].split(":")[1];t.currentTime=p}}else if(o.toString().startsWith("latency")){const n=parseFloat(o.toString().split("@")[1]);this.playbackDelta=n}else if(o.toString().startsWith("timestamp")){const n=parseFloat(o.toString().split("@")[1]),p=(Date.now()-n)/1e3;this.playbackDelta=p,l.send(`latency@${p}`)}}),l.on("error",o=>{r.e(`和 ${s.app.roomID} 的连接建立失败: ${o.message}`),console.error(o),this.connectionAttempts++,setTimeout(()=>this.connectToPeer(),1e3)}),l.on("close",()=>{r.w("连接已关闭"),s.peers.remote.data=null,this.isReady=!1,document.getElementById("video-player-stream").pause()})}},mounted(){if(this.roomID===""){this.$router.replace("/");return}const a=this;if(this.isSlave){const e=s.peers.local.data;e.open?this.connectToPeer():e.on("open",()=>{this.connectToPeer()})}else navigator.clipboard.writeText(this.roomID),s.peers.local.data.on("connection",e=>{e.on("open",function(){r.i(`已收到来自 ${e.peer} 的连接`),s.peers.remote.data=e}),e.on("data",function(l){const o=l.toString().split("@")[0],t=l.toString().split("@")[1];if(o==="connected")if(r.i(`和 ${e.peer} 的连接已建立`),a.isReady=!0,s.app.method==0){const n=document.querySelector("#video-player-stream").captureStream();s.peers.local.video.call(`${t}-video`,n),s.app.pingThread=setInterval(()=>{e.send(`timestamp@${Date.now()}`)},"1"*1e3)}else{const n=document.getElementById("video-player-stream");e.send(`origin@${s.app.videoURL}`),n.addEventListener("play",()=>{e.send("video@play")}),n.addEventListener("pause",()=>{e.send("video@pause")}),n.addEventListener("seeking",()=>{e.send(`video@seek:${n.currentTime}`)})}else if(o=="video"){const n=document.getElementById("video-player-stream"),p=l.toString().split("@")[1];if(p.startsWith("sync")){const c=p.split(":")[1]-n.currentTime;Math.abs(c)>"0.1"?(r.w(`时间差过大，尝试同步。时间差：${c}`),a.playbackDelta=c,e.send(`video@seek:${n.currentTime}`)):(r.i(`收到从节点报告的播放进度。时间差：${c}`),a.playbackDelta=c),e.send(`latency@${c}`)}}else if(o=="latency"){const n=l.toString().split("@")[1];a.playbackDelta=n}else r.e(`收到无效消息：${l}`)}),e.on("close",()=>{r.w("连接已关闭"),s.peers.remote.data=null,this.isReady=!1,document.getElementById("video-player-stream").pause()})}),(e=>{e.src=s.app.videoURL,e.load()})(document.querySelector("#video-player-stream"))},beforeUnmount(){s.app.syncThread&&clearInterval(s.app.syncThread),s.app.pingThread&&clearInterval(s.app.pingThread)},components:{"loading-ring":T,"video-player":D}},$={class:"container-c"},E={class:"monospace",id:"room-id-indicator"},w={key:0},B={key:1},P={id:"status"},V={key:0};function x(a,e,l,o,t,n){const p=f("loading-ring"),v=f("video-player");return m(),u("div",$,[e[2]||(e[2]=i("h1",null,"流式传输",-1)),i("span",E,"您的"+d(t.roleDescription)+"号："+d(t.roomID),1),t.isReady?y("",!0):(m(),u("span",w,"⠀"+d(t.hint),1)),e[3]||(e[3]=i("br",null,null,-1)),t.isReady?y("",!0):(m(),u("div",B,[e[0]||(e[0]=i("br",null,null,-1)),g(p,{id:"loading"}),e[1]||(e[1]=i("br",null,null,-1)),i("h3",null,d(t.loadingDescription),1)])),e[4]||(e[4]=i("br",null,null,-1)),g(v,{id:"video-player-stream",style:h({display:t.isReady?"block":"none"})},null,8,["style"]),e[5]||(e[5]=i("br",null,null,-1)),e[6]||(e[6]=i("br",null,null,-1)),i("span",P,[i("s",{style:h({color:t.isReady?"green":"red"})},"⬤",4),I(" "+d(t.isReady?"已连接":"未连接")+"："+d(t.isSlave?"正在观看视频流":`正在推送${t.method==1?"同源":"点对点"}视频流`)+" ",1),(!t.isSlave&&t.method==1||t.isSlave||!t.isSlave&&t.method==0)&&t.isReady?(m(),u("div",V,"  ("+d(t.method==1?"视频进度差异":"网络延迟")+"："+d(t.playbackDelta?Math.round(t.playbackDelta*1e3):"正在测量")+d(t.playbackDelta?"ms":"")+") ",1)):y("",!0)])])}const W=S(R,[["render",x],["__scopeId","data-v-69204125"]]);export{W as default};
